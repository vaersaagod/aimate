{"version":3,"file":"aimate.js","sources":["../../../../build/src/components/CustomPromptModal.js","../../../../build/src/aimate.js"],"sourcesContent":["const CustomPromptModal = Garnish.Modal.extend({\n    init: function () {\n\n        this.base();\n        this.setSettings({\n            resizable: true,\n        });\n\n        const $modalContainerDiv = $(\n            '<div class=\"modal fitted aimate-customprompt\"></div>'\n        )\n            .addClass()\n            .appendTo(Garnish.$bod);\n\n        const $body = $(`\n                <div class=\"body\" style=\"display:flex;flex-direction:column;min-height:100%;\">\n                    <div class=\"header\" style=\"flex: none;\">\n                        <h1 style=\"margin-bottom:10px;\">Custom prompt</h1>\n                        <p class=\"notice has-icon\">\n                            <span class=\"icon\" aria-hidden=\"true\"></span>\n                            <span>Add a &lt;text&gt; token to the prompt to include the current value in the field.</span>\n                        </p>\n                    </div>\n                    <form method=\"post\" accept-charset=\"UTF-8\" style=\"display:flex;height:100%;flex: 1 1 auto;position:relative;\">\n                        <textarea style=\"width:420px;min-width:100%;max-width:100%;resize:none;padding:10px;\"></textarea>\n                    </form>\n                </div>\n            `).appendTo(\n            $modalContainerDiv.empty()\n        );\n\n        const $footer = $('<div class=\"footer\"/>').appendTo($body);\n        const $footerBtnContainer = $('<div class=\"buttons right\"/>').appendTo($footer);\n        const $cancelBtn = $('<button/>', {\n            type: 'button',\n            class: 'btn',\n            text: Craft.t('app', 'Cancel'),\n        }).appendTo($footerBtnContainer);\n\n        const $applyBtn = Craft.ui\n            .createSubmitButton({ label: Craft.t('app', 'Apply') })\n            .appendTo($footerBtnContainer);\n\n        this.$textarea = $body.find('textarea');\n\n        this.addListener($cancelBtn, 'click', 'onCancel');\n        this.addListener($applyBtn, 'click', 'onApply');\n\n        const _this = this;\n\n        this.$textarea = $modalContainerDiv.find('textarea');\n\n        this.setContainer($modalContainerDiv);\n\n    },\n\n    onShow: function () {\n        const _this = this;\n        this.promise = new Promise((resolve, reject) => {\n            _this.reject = reject;\n            _this.resolve = resolve;\n        });\n    },\n\n    onHide: function () {\n        this.$textarea.val('');\n    },\n\n    onCancel: function () {\n        this.resolve();\n        this.hide();\n    },\n\n    onApply: function () {\n        this.resolve(this.$textarea.val());\n        this.hide();\n    },\n\n    getText: function () {\n        return this.promise;\n    }\n\n});\n\nexport default CustomPromptModal;\n","import CustomPromptModal from \"./components/CustomPromptModal.js\";\n\nimport './aimate.scss';\n\n$(() => {\n\n    let customPromptModal;\n\n    const onPromptClick = async e => {\n        console.log('AIMate :: onPromptClick');\n        //e.preventDefault();\n\n        const { currentTarget: promptLink } = e;\n\n        const { field: fieldId, element: elementId, site: siteId, layoutElement: layoutElementUid } = promptLink.dataset;\n        const field = $('body').find('.field[data-layout-element=\"' + layoutElementUid + '\"]');\n\n        if (field.length === 0) {\n            Craft.cp.displayError('Field not found');\n            return;\n        }\n\n        const { type: fieldType } = field.get(0).dataset;\n\n        let input;\n\n        if (fieldType === 'craft\\\\fields\\\\Table') {\n            // Does not work yet\n            // input = menuButton.closest('td.textual').querySelector('input,textarea');\n        } else {\n            input = field.find('.input input,textarea').get(0);\n        }\n\n        if (!input) {\n            Craft.cp.displayError('Input not found');\n            return;\n        }\n\n        let params = {};\n\n        if (promptLink.hasAttribute('data-custom')) {\n            if (!customPromptModal) {\n                customPromptModal = new CustomPromptModal();\n            }\n            customPromptModal.show();\n            const customPrompt = await customPromptModal.getText();\n            if (!customPrompt) {\n                return;\n            }\n            params.custom = customPrompt;\n        } else {\n            const { prompt } = promptLink.dataset;\n\n            if (!prompt) {\n                Craft.cp.displayError('No prompt');\n                return;\n            }\n            params.prompt = prompt;\n        }\n\n        const elementEditor = $(input.closest('[data-element-editor]')).data('elementEditor');\n\n        params = {\n            ...params,\n            elementId,\n            siteId\n        };\n\n        if (elementEditor) {\n            params = {\n                ...params,\n                draftId: elementEditor.settings.draftId,\n                isProvisionalDraft: elementEditor.settings.isProvisionalDraft\n            };\n        }\n\n        //menuButton.classList.add('loading');\n        Craft.sendActionRequest(\n            'POST',\n            '_aimate/default/do-prompt',\n            {\n                data: {\n                    text: input.value,\n                    ...params\n                }\n            }\n        ).then(res => {\n            const { data } = res;\n            if (!data.text) {\n                return;\n            }\n            const field = input.closest('.field');\n            const { type: fieldType } = field.dataset;\n            if (fieldType === 'craft\\\\ckeditor\\\\Field') {\n                const editable = field.querySelector('.ck-editor__editable');\n                const ckEditorInstance = editable ? editable.ckeditorInstance : null;\n                if (!ckEditorInstance) {\n                    throw new Error('Unable to find CKEditor instance in DOM');\n                }\n                ckEditorInstance.focus();\n                ckEditorInstance.execute('selectAll');\n                const viewFragment = ckEditorInstance.data.processor.toView(data.text);\n                const modelFragment = ckEditorInstance.data.toModel(viewFragment);\n                ckEditorInstance.model.insertContent(modelFragment);\n            } else if (fieldType === 'craft\\\\redactor\\\\Field') {\n                const redactorInstance = $R(`#${input.id}`);\n                redactorInstance.editor.focus();\n                redactorInstance.insertion.set(data.text);\n                redactorInstance.source.getElement().val(data.text);\n            } else {\n                input.focus();\n                input.select();\n                if (!document.execCommand('insertText', false, data.text)) {\n                    input.setRangeText(data.text);\n                }\n            }\n            if (elementEditor) {\n                elementEditor.checkForm();\n            }\n        }).catch(({ response }) => {\n            Craft.cp.displayError(response.message || response.data.message);\n        }).catch(error => {\n            console.error(error);\n        }).then(() => {\n            //menuButton.classList.remove('loading');\n            input.focus();\n        });\n    };\n\n    const onGenerateAltTextClick = e => {\n        console.log('AIMate :: onGenerateAltTextClick');\n\n        e.preventDefault();\n\n        const { currentTarget: generateButton } = e;\n        console.log(generateButton.dataset);\n        const { element: elementId, site: siteId } = generateButton.dataset;\n\n        const params = {\n            elementId,\n            siteId\n        };\n\n        console.log(params);\n        \n        generateButton.classList.add('loading');\n\n        Craft.sendActionRequest(\n            'POST',\n            '_aimate/default/generate-alt-text',\n            {\n                data: { ...params }\n            }\n        ).then(res => {\n            const { data } = res;\n            window.location.reload();\n        }).catch(({ response }) => {\n            Craft.cp.displayError(response.message || response.data.message);\n        }).catch(error => {\n            console.error(error);\n        }).then(() => {\n            generateButton.classList.remove('loading');\n        });\n    }\n\n    /*\n    const initTableRow = $tr => {\n        const field = $tr.get(0).closest('.field');\n        if (!field) {\n            return;\n        }\n        const aimateButton = field.querySelector('button[data-aimate]');\n        if (!aimateButton) {\n            return;\n        }\n        const tds = $tr.children().get().filter(td => td.classList.contains('singleline-cell', 'multiline-cell'));\n        const trId = $tr.index();\n        tds.forEach(td => {\n            const $aimateButton = $(aimateButton).clone(false, true);\n            const menuId = $aimateButton.attr('aria-controls');\n            const $menu = $($(`#${menuId}`)).clone(false, true);\n            const textarea = td.querySelector('textarea');\n            const tdId = `${trId}-${$(td).index()}`;\n            $menu.attr('id', `${$menu.attr('id')}-${trId}-${tdId}`);\n            $('body').append($menu);\n            $aimateButton.attr('aria-controls', $menu.attr('id'));\n            $(textarea.parentNode).prepend($aimateButton.disclosureMenu());\n        });\n    };\n    */\n\n    console.log('AIMate :: init');\n\n    /*\n    $('.field table.editable tbody tr').each(function () {\n        initTableRow($(this));\n    });\n\n    const rowInitFn = Craft.EditableTable.Row.prototype.init;\n    Craft.EditableTable.Row.prototype.init = function () {\n        rowInitFn.apply(this, arguments);\n        initTableRow(this.$tr);\n    };\n    */\n\n    $('body').on('click', '[data-aimate-prompt-button]', onPromptClick);\n    $('body').on('click', '[data-aimate-generate-alt-text-button]', onGenerateAltTextClick);\n\n});\n\n// Accept HMR as per: https://vitejs.dev/guide/api-hmr.html\nif (import.meta.hot) {\n    import.meta.hot.accept();\n}\n"],"names":["CustomPromptModal","$modalContainerDiv","$body","$footer","$footerBtnContainer","$cancelBtn","$applyBtn","_this","resolve","reject","customPromptModal","onPromptClick","e","promptLink","fieldId","elementId","siteId","layoutElementUid","field","fieldType","input","params","customPrompt","prompt","elementEditor","res","data","editable","ckEditorInstance","viewFragment","modelFragment","redactorInstance","response","error","onGenerateAltTextClick","generateButton"],"mappings":"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"}